# Iltero CI/CD Pipeline
# Generated by Iltero Platform
# 
# Required Secrets:
#   ILTERO_API_TOKEN - Authenticate with Iltero API (required)
#   ILTERO_REGISTRY_TOKEN - Private module registry access (optional)
#
# GITHUB_TOKEN is automatically provided by GitHub Actions

name: Iltero Pipeline

on:
  push:
    branches: [main, develop, staging]
    paths:
      - 'infra/stacks/**'
      - '.github/workflows/iltero.yml'
  pull_request:
    branches: [main, develop, staging]
    paths:
      - 'infra/stacks/**'
  workflow_dispatch:
    inputs:
      stack:
        description: 'Stack to process (leave empty for all changed)'
        required: false
        type: string
      environment:
        description: 'Target environment (auto-detected from branch if empty)'
        required: false
        type: choice
        options:
          - production
          - development
          - staging

# Explicit permissions following principle of least privilege
permissions:
  contents: read
  pull-requests: write
  actions: read

concurrency:
  group: iltero-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ==========================================================================
  # Job 1: Compliance & Evaluation
  # Runs for all events - validates infrastructure changes
  # ==========================================================================
  compliance:
    name: Compliance & Evaluation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect-env.outputs.environment }}
      require_approval: ${{ steps.detect-env.outputs.require_approval }}
      compliance_passed: ${{ steps.pipeline.outputs.compliance_passed }}
      evaluation_passed: ${{ steps.pipeline.outputs.evaluation_passed }}
      stacks_processed: ${{ steps.pipeline.outputs.stacks_processed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Required Secrets
        run: |
          if [ -z "${{ secrets.ILTERO_API_TOKEN }}" ]; then
            echo "::error::ILTERO_API_TOKEN secret is not configured. Please add it in Repository Settings â†’ Secrets."
            exit 1
          fi

      - name: Detect Environment
        id: detect-env
        run: |
          # Check if environment is explicitly provided (workflow_dispatch)
          if [ -n "${{ github.event.inputs.environment }}" ]; then
            ENV="${{ github.event.inputs.environment }}"
            echo "environment=$ENV" >> $GITHUB_OUTPUT
            
            # Determine if this environment requires approval
            case "$ENV" in
              "production")
                echo "require_approval=true" >> $GITHUB_OUTPUT
                ;;
              "development")
                echo "require_approval=false" >> $GITHUB_OUTPUT
                ;;
              "staging")
                echo "require_approval=false" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "require_approval=true" >> $GITHUB_OUTPUT
                ;;
            esac
          else
            # Auto-detect from branch
            BRANCH="${GITHUB_REF#refs/heads/}"
            
            # For pull requests, use the base branch
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              BRANCH="${{ github.base_ref }}"
            fi
            
            echo "Detecting environment for branch: $BRANCH"
            
            case "$BRANCH" in
            "main")
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "require_approval=true" >> $GITHUB_OUTPUT
              ;;
            "develop")
              echo "environment=development" >> $GITHUB_OUTPUT
              echo "require_approval=false" >> $GITHUB_OUTPUT
              ;;
            "staging")
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "require_approval=false" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "::warning::No environment mapping found for branch '$BRANCH', defaulting to 'production'"
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "require_approval=true" >> $GITHUB_OUTPUT
              ;;
            esac
          fi
          
          echo "Detected environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d= -f2)"

      - name: Iltero Pipeline (Scan & Evaluate)
        id: pipeline
        uses: iltero-io/iltero-actions/pipeline@v1
        with:
          config_paths: infra/stacks
          stack: ${{ github.event.inputs.stack || '' }}
          environment: ${{ steps.detect-env.outputs.environment }}
          dry_run: ${{ steps.detect-env.outputs.require_approval }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ILTERO_API_TOKEN: ${{ secrets.ILTERO_API_TOKEN }}

  # ==========================================================================
  # Job 2: Auto-Deploy (for environments NOT requiring approval)
  # Only runs on push events when compliance passes
  # ==========================================================================
  deploy-auto:
    name: Deploy (Auto)
    needs: compliance
    if: |
      needs.compliance.outputs.compliance_passed == 'true' &&
      github.event_name == 'push' &&
      (steps.detect-env.outputs.environment == 'development' || steps.detect-env.outputs.environment == 'staging')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy Infrastructure
        uses: iltero-io/iltero-actions/pipeline@v1
        with:
          config_paths: infra/stacks
          stack: ${{ github.event.inputs.stack || '' }}
          environment: ${{ needs.compliance.outputs.environment }}
          deploy_only: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ILTERO_API_TOKEN: ${{ secrets.ILTERO_API_TOKEN }}
          ILTERO_REGISTRY_TOKEN: ${{ secrets.ILTERO_REGISTRY_TOKEN }}

  # ==========================================================================
  # Job: Deploy to Production (requires approval)
  # Uses GitHub Environment protection rules for approval gate
  # ==========================================================================
  deploy-production:
    name: Deploy to Production
    needs: compliance
    if: |
      needs.compliance.outputs.compliance_passed == 'true' &&
      needs.compliance.outputs.environment == 'production' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to Production
        uses: iltero-io/iltero-actions/pipeline@v1
        with:
          config_paths: infra/stacks
          stack: ${{{ github.event.inputs.stack || '' }}}
          environment: production
          deploy_only: 'true'
        env:
          GITHUB_TOKEN: ${{{ secrets.GITHUB_TOKEN }}}
          ILTERO_API_TOKEN: ${{{ secrets.ILTERO_API_TOKEN }}}
          ILTERO_REGISTRY_TOKEN: ${{{ secrets.ILTERO_REGISTRY_TOKEN }}}
