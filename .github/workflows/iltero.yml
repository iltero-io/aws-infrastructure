# Iltero CI/CD Pipeline
# Generated by Iltero Platform
#
# Required Secrets:
#   ILTERO_API_TOKEN - Authenticate with Iltero API (required)
#   ILTERO_REGISTRY_TOKEN - Private module registry access (required for terraform init)
#
# Cloud Authentication:
#   Handled by iltero-actions based on each stack's config.yml
#   Configure cloud credentials in stack config (cloud.provider, cloud.role_arn, etc.)
#   The workflow requests id-token:write permission for OIDC federation
#
# GITHUB_TOKEN is automatically provided by GitHub Actions
#
# Environment is auto-detected from branch via git_ref mapping in config.yml

name: Iltero Pipeline

on:
  push:
    branches: [main, develop, staging]
    paths:
      - 'infra/stacks/**'
      - '.github/workflows/iltero.yml'
  pull_request:
    branches: [main, develop, staging]
    paths:
      - 'infra/stacks/**'
  workflow_dispatch:
    inputs:
      stack:
        description: 'Stack to process (leave empty for all changed)'
        required: false
        type: string
      environment:
        description: 'Target environment (auto-detected from branch if empty)'
        required: false
        type: choice
        options:
          - production
          - development
          - staging

# Explicit permissions following principle of least privilege
permissions:
  contents: read
  pull-requests: write
  actions: read
  id-token: write  # Required for OIDC cloud authentication

concurrency:
  group: iltero-${{{ github.repository }}}-${{{ github.ref }}}
  cancel-in-progress: false

jobs:
  # ==========================================================================
  # Job 1: Compliance & Evaluation
  # Runs for all events - validates infrastructure changes
  # Environment is auto-detected from branch via config.yml git_ref mapping
  # ==========================================================================
  compliance:
    name: Compliance & Evaluation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{{ steps.pipeline.outputs.environment }}}
      compliance_passed: ${{{ steps.pipeline.outputs.compliance_passed }}}
      evaluation_passed: ${{{ steps.pipeline.outputs.evaluation_passed }}}
      stacks_processed: ${{{ steps.pipeline.outputs.stacks_processed }}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Required Secrets
        run: |
          if [ -z "${{{ secrets.ILTERO_API_TOKEN }}}" ]; then
            echo "::error::ILTERO_API_TOKEN secret is not configured. Please add it in Repository Settings â†’ Secrets."
            exit 1
          fi
          if [ -z "${{{ secrets.ILTERO_REGISTRY_TOKEN }}}" ]; then
            echo "::error::ILTERO_REGISTRY_TOKEN secret is not configured. Required for terraform init with private modules."
            exit 1
          fi

      - name: Iltero Pipeline (Scan & Evaluate)
        id: pipeline
        uses: iltero-io/iltero-actions/pipeline@v1
        with:
          config_paths: infra/stacks
          stack: ${{{ github.event.inputs.stack || '' }}}
          environment: ${{{ github.event.inputs.environment || '' }}}
        env:
          GITHUB_TOKEN: ${{{ secrets.GITHUB_TOKEN }}}
          ILTERO_API_TOKEN: ${{{ secrets.ILTERO_API_TOKEN }}}
          ILTERO_REGISTRY_TOKEN: ${{{ secrets.ILTERO_REGISTRY_TOKEN }}}

  # ==========================================================================
  # Job 2: Auto-Deploy (for environments NOT requiring approval)
  # Only runs on push events when compliance passes
  # ==========================================================================
  deploy-auto:
    name: Deploy (Auto)
    needs: compliance
    if: |
      needs.compliance.outputs.compliance_passed == 'true' &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/staging')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy Infrastructure
        uses: iltero-io/iltero-actions/pipeline@v1
        with:
          config_paths: infra/stacks
          stack: ${{{ github.event.inputs.stack || '' }}}
          environment: ${{{ needs.compliance.outputs.environment }}}
          deploy_only: 'true'
        env:
          GITHUB_TOKEN: ${{{ secrets.GITHUB_TOKEN }}}
          ILTERO_API_TOKEN: ${{{ secrets.ILTERO_API_TOKEN }}}
          ILTERO_REGISTRY_TOKEN: ${{{ secrets.ILTERO_REGISTRY_TOKEN }}}

  # ==========================================================================
  # Job: Deploy to Production (requires approval)
  # Uses GitHub Environment protection rules for approval gate
  # ==========================================================================
  deploy-production:
    name: Deploy to Production
    needs: compliance
    if: |
      needs.compliance.outputs.compliance_passed == 'true' &&
      needs.compliance.outputs.environment == 'production' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to Production
        uses: iltero-io/iltero-actions/pipeline@v1
        with:
          config_paths: infra/stacks
          stack: ${{{ github.event.inputs.stack || '' }}}
          environment: production
          deploy_only: 'true'
        env:
          GITHUB_TOKEN: ${{{ secrets.GITHUB_TOKEN }}}
          ILTERO_API_TOKEN: ${{{ secrets.ILTERO_API_TOKEN }}}
          ILTERO_REGISTRY_TOKEN: ${{{ secrets.ILTERO_REGISTRY_TOKEN }}}
