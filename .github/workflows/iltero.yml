# Iltero CI/CD Pipeline
# Generated by Iltero Platform
#
# ============================================================================
# SETUP INSTRUCTIONS
# ============================================================================
#
# 1. REQUIRED REPOSITORY SECRETS (Settings → Secrets and variables → Actions)
#    - ILTERO_API_TOKEN: Your Iltero API token (required)
#    - ILTERO_REGISTRY_TOKEN: Private module registry access (required for terraform init)
#
# 2. GITHUB ENVIRONMENTS SETUP (Settings → Environments)
#    Create an environment for each deployment target (e.g., 'development', 'production').
#    For each environment, configure:
#
#    a) Environment Variables (Environment → Add variable):
#       - AWS_ROLE_ARN: arn:aws:iam::ACCOUNT_ID:role/YOUR_ROLE_NAME
#       - AWS_REGION: us-east-1 (or your preferred region)
#
#    b) Protection Rules (optional but recommended for production):
#       - Enable "Required reviewers" and add approvers
#       - Limit which branches can deploy to this environment
#
# 3. AWS OIDC SETUP (one-time)
#    Create an IAM OIDC identity provider for GitHub Actions:
#    - Provider URL: https://token.actions.githubusercontent.com
#    - Audience: sts.amazonaws.com
#    Then create an IAM role with trust policy for your repository.
#    See: https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services
#
# GITHUB_TOKEN is automatically provided by GitHub Actions.
# Environment is auto-detected from branch via git_ref mapping in config.yml.
# ============================================================================

name: Iltero Pipeline

on:
  push:
    branches: [main, develop, staging]
    paths:
      - 'infra/stacks/**'
      - '.github/workflows/iltero.yml'
  pull_request:
    branches: [main, develop, staging]
    paths:
      - 'infra/stacks/**'
  workflow_dispatch:
    inputs:
      stack:
        description: 'Stack to process (leave empty for all changed)'
        required: false
        type: string
      environment:
        description: 'Target environment (auto-detected from branch if empty)'
        required: false
        type: choice
        options:
          - production
          - development
          - staging

# Explicit permissions following principle of least privilege
permissions:
  contents: read
  pull-requests: write
  actions: read
  id-token: write  # Required for OIDC cloud authentication

concurrency:
  group: iltero-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ==========================================================================
  # Compliance Job
  # Runs for all events - validates infrastructure changes
  # Environment is auto-detected from branch via config.yml git_ref mapping
  # ==========================================================================
  compliance:
    name: Compliance
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.pipeline.outputs.environment }}
      compliance_passed: ${{ steps.pipeline.outputs.compliance_passed }}
      evaluation_passed: ${{ steps.pipeline.outputs.evaluation_passed }}
      stacks_processed: ${{ steps.pipeline.outputs.stacks_processed }}
      run_id: ${{ steps.pipeline.outputs.run_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Required Secrets
        run: |
          if [ -z "${{ secrets.ILTERO_API_TOKEN }}" ]; then
            echo "::error::ILTERO_API_TOKEN secret is not configured. Please add it in Repository Settings → Secrets."
            exit 1
          fi
          if [ -z "${{ secrets.ILTERO_REGISTRY_TOKEN }}" ]; then
            echo "::error::ILTERO_REGISTRY_TOKEN secret is not configured. Required for terraform init with private modules."
            exit 1
          fi

      - name: Iltero Pipeline (Scan & Evaluate)
        id: pipeline
        uses: ilterohq/iltero-actions@v1
        with:
          stacks_path: infra/stacks
          stack: ${{ github.event.inputs.stack || '' }}
          environment: ${{ github.event.inputs.environment || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ILTERO_API_TOKEN: ${{ secrets.ILTERO_API_TOKEN }}
          ILTERO_REGISTRY_TOKEN: ${{ secrets.ILTERO_REGISTRY_TOKEN }}

  # ==========================================================================
  # Auto-Deploy Job (for environments NOT requiring approval)
  # Only runs on push events when compliance passes
  # Uses pipeline action in deploy-only mode with authorization verification
  # ==========================================================================
  deploy-auto:
    name: Deploy (Auto)
    needs: compliance
    if: |
      needs.compliance.outputs.compliance_passed == 'true' &&
      github.event_name == 'push' &&
      (needs.compliance.outputs.environment == 'development' || needs.compliance.outputs.environment == 'staging')
    runs-on: ubuntu-latest
    environment: ${{ needs.compliance.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Deploy Infrastructure
        uses: ilterohq/iltero-actions@v1
        with:
          stacks_path: infra/stacks
          stack: ${{ github.event.inputs.stack || '' }}
          environment: ${{ needs.compliance.outputs.environment }}
          deploy_only: 'true'
          run_id: ${{ needs.compliance.outputs.run_id }}
          verify_authorization: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ILTERO_API_TOKEN: ${{ secrets.ILTERO_API_TOKEN }}
          ILTERO_REGISTRY_TOKEN: ${{ secrets.ILTERO_REGISTRY_TOKEN }}

  # ==========================================================================
  # Deploy to Production Job (requires approval)
  # Uses GitHub Environment protection rules for approval gate
  # Backend authorization verification ensures compliance passed
  # ==========================================================================
  deploy-production:
    name: Deploy to Production
    needs: compliance
    if: |
      needs.compliance.outputs.compliance_passed == 'true' &&
      needs.compliance.outputs.environment == 'production' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Deploy to Production
        uses: ilterohq/iltero-actions@v1
        with:
          stacks_path: infra/stacks
          stack: ${{ github.event.inputs.stack || '' }}
          environment: production
          deploy_only: 'true'
          run_id: ${{ needs.compliance.outputs.run_id }}
          verify_authorization: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ILTERO_API_TOKEN: ${{ secrets.ILTERO_API_TOKEN }}
          ILTERO_REGISTRY_TOKEN: ${{ secrets.ILTERO_REGISTRY_TOKEN }}
